services:
  # Rails API Backend
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: fintrack_api
    environment:
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
    volumes:
      - api_storage:/rails/storage
      - api_logs:/rails/log
    ports:
      - "3000:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # React Frontend with Nginx
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: fintrack_web
    ports:
      - "8080:80"
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Telegram Bot
  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: fintrack_bot
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEBAPP_URL: ${WEBAPP_URL}
      API_URL: ${API_URL:-http://api:80}
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  # Cron service for notifications
  cron:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: fintrack_cron
    environment:
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      WEBAPP_URL: ${WEBAPP_URL}
      BUNDLE_PATH: /usr/local/bundle
      PATH: /usr/local/bundle/bin:/usr/local/bin:/usr/bin:/bin
    volumes:
      - api_storage:/rails/storage
      - api_logs:/rails/log
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    user: root
    command: |
      sh -c "
        cat > /etc/cron.d/notifications << CRONEOF
      PATH=/usr/local/bundle/bin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      BUNDLE_PATH=/usr/local/bundle
      RAILS_ENV=production
      RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
      TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      */5 * * * * root cd /rails && /usr/local/bin/bundle exec rake notifications:send_reminders >> /rails/log/cron.log 2>&1
      CRONEOF
        chmod 0644 /etc/cron.d/notifications &&
        touch /rails/log/cron.log &&
        echo 'Cron service started. Notifications will run every 5 minutes.' &&
        /usr/sbin/cron -f
      "

volumes:
  api_storage:
    driver: local
  api_logs:
    driver: local
